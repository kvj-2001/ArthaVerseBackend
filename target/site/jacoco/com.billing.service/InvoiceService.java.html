<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InvoiceService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">billing-backend</a> &gt; <a href="index.source.html" class="el_package">com.billing.service</a> &gt; <span class="el_source">InvoiceService.java</span></div><h1>InvoiceService.java</h1><pre class="source lang-java linenums">package com.billing.service;

import com.billing.dto.InvoiceDto;
import com.billing.dto.InvoiceItemDto;
import com.billing.entity.Invoice;
import com.billing.entity.InvoiceItem;
import com.billing.entity.Product;
import com.billing.exception.BadRequestException;
import com.billing.exception.ResourceNotFoundException;
import com.billing.repository.InvoiceRepository;
import com.billing.repository.ProductRepository;
import com.billing.security.UserPrincipal;
import org.modelmapper.ModelMapper;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.Year;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

@Service
@Transactional
<span class="nc" id="L33">public class InvoiceService {</span>
    
<span class="nc" id="L35">    private static final Logger logger = LoggerFactory.getLogger(InvoiceService.class);</span>
    
    @Autowired
    private InvoiceRepository invoiceRepository;
    
    @Autowired
    private ProductRepository productRepository;
    
    @Autowired
    private ModelMapper modelMapper;
    
    @Autowired
    private PdfService pdfService;
    
    private Long getCurrentUserId() {
<span class="nc" id="L50">        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="nc bnc" id="L51" title="All 4 branches missed.">        if (authentication != null &amp;&amp; authentication.getPrincipal() instanceof UserPrincipal) {</span>
<span class="nc" id="L52">            return ((UserPrincipal) authentication.getPrincipal()).getId();</span>
        }
<span class="nc" id="L54">        throw new RuntimeException(&quot;User not authenticated&quot;);</span>
    }
    
    public InvoiceDto createInvoice(InvoiceDto invoiceDto) {
<span class="nc" id="L58">        Long userId = getCurrentUserId();</span>
        
<span class="nc" id="L60">        Invoice invoice = new Invoice();</span>
<span class="nc" id="L61">        invoice.setInvoiceNumber(generateInvoiceNumber(userId));</span>
<span class="nc" id="L62">        invoice.setInvoiceDate(invoiceDto.getInvoiceDate());</span>
<span class="nc" id="L63">        invoice.setDueDate(invoiceDto.getDueDate());</span>
<span class="nc" id="L64">        invoice.setCustomerName(invoiceDto.getCustomerName());</span>
<span class="nc" id="L65">        invoice.setCustomerEmail(invoiceDto.getCustomerEmail());</span>
<span class="nc" id="L66">        invoice.setCustomerPhone(invoiceDto.getCustomerPhone());</span>
<span class="nc" id="L67">        invoice.setCustomerAddress(invoiceDto.getCustomerAddress());</span>
<span class="nc" id="L68">        invoice.setTaxAmount(invoiceDto.getTaxAmount());</span>
<span class="nc" id="L69">        invoice.setDiscountAmount(invoiceDto.getDiscountAmount());</span>
<span class="nc" id="L70">        invoice.setNotes(invoiceDto.getNotes());</span>
<span class="nc" id="L71">        invoice.setStatus(invoiceDto.getStatus());</span>
<span class="nc" id="L72">        invoice.setUserId(userId);</span>
        
        // Process invoice items
<span class="nc" id="L75">        List&lt;InvoiceItem&gt; invoiceItems = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">        for (InvoiceItemDto itemDto : invoiceDto.getItems()) {</span>
<span class="nc" id="L77">            Product product = productRepository.findById(itemDto.getProductId())</span>
<span class="nc" id="L78">                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Product&quot;, &quot;id&quot;, itemDto.getProductId()));</span>
            
<span class="nc bnc" id="L80" title="All 2 branches missed.">            if (!product.getUserId().equals(userId)) {</span>
<span class="nc" id="L81">                throw new BadRequestException(&quot;Product does not belong to the current user&quot;);</span>
            }
            
            // Allow invoice creation even with zero stock - stock validation removed
            // Note: Product can have negative stock after this operation
            
<span class="nc" id="L87">            InvoiceItem item = new InvoiceItem();</span>
<span class="nc" id="L88">            item.setProduct(product);</span>
<span class="nc" id="L89">            item.setQuantity(itemDto.getQuantity());</span>
<span class="nc" id="L90">            item.setUnitPrice(itemDto.getUnitPrice());</span>
<span class="nc" id="L91">            item.setDescription(itemDto.getDescription());</span>
<span class="nc" id="L92">            item.setInvoice(invoice);</span>
            
<span class="nc" id="L94">            invoiceItems.add(item);</span>
            
            // Update product quantity (convert BigDecimal to Integer for storage)
<span class="nc" id="L97">            int newQuantity = BigDecimal.valueOf(product.getQuantity()).subtract(itemDto.getQuantity()).intValue();</span>
<span class="nc" id="L98">            product.setQuantity(newQuantity);</span>
<span class="nc" id="L99">            productRepository.save(product);</span>
<span class="nc" id="L100">        }</span>
        
<span class="nc" id="L102">        invoice.setItems(invoiceItems);</span>
<span class="nc" id="L103">        invoice.calculateTotals();</span>
        
<span class="nc" id="L105">        Invoice savedInvoice = invoiceRepository.save(invoice);</span>
        
<span class="nc" id="L107">        logger.info(&quot;Invoice created: {} by user: {}&quot;, savedInvoice.getInvoiceNumber(), userId);</span>
        
<span class="nc" id="L109">        return convertToDto(savedInvoice);</span>
    }
    
    public InvoiceDto updateInvoice(Long id, InvoiceDto invoiceDto) {
<span class="nc" id="L113">        Long userId = getCurrentUserId();</span>
        
<span class="nc" id="L115">        Invoice invoice = invoiceRepository.findById(id)</span>
<span class="nc" id="L116">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Invoice&quot;, &quot;id&quot;, id));</span>
        
<span class="nc bnc" id="L118" title="All 2 branches missed.">        if (!invoice.getUserId().equals(userId)) {</span>
<span class="nc" id="L119">            throw new BadRequestException(&quot;You don't have permission to update this invoice&quot;);</span>
        }
        
<span class="nc bnc" id="L122" title="All 2 branches missed.">        if (invoice.getStatus() == Invoice.InvoiceStatus.PAID) {</span>
<span class="nc" id="L123">            throw new BadRequestException(&quot;Cannot update a paid invoice&quot;);</span>
        }
        
        // Restore product quantities from existing items
<span class="nc bnc" id="L127" title="All 2 branches missed.">        for (InvoiceItem existingItem : invoice.getItems()) {</span>
<span class="nc" id="L128">            Product product = existingItem.getProduct();</span>
<span class="nc" id="L129">            int newQuantity = BigDecimal.valueOf(product.getQuantity()).add(existingItem.getQuantity()).intValue();</span>
<span class="nc" id="L130">            product.setQuantity(newQuantity);</span>
<span class="nc" id="L131">            productRepository.save(product);</span>
<span class="nc" id="L132">        }</span>
        
        // Clear existing items
<span class="nc" id="L135">        invoice.getItems().clear();</span>
        
        // Update invoice details
<span class="nc" id="L138">        invoice.setInvoiceDate(invoiceDto.getInvoiceDate());</span>
<span class="nc" id="L139">        invoice.setDueDate(invoiceDto.getDueDate());</span>
<span class="nc" id="L140">        invoice.setCustomerName(invoiceDto.getCustomerName());</span>
<span class="nc" id="L141">        invoice.setCustomerEmail(invoiceDto.getCustomerEmail());</span>
<span class="nc" id="L142">        invoice.setCustomerPhone(invoiceDto.getCustomerPhone());</span>
<span class="nc" id="L143">        invoice.setCustomerAddress(invoiceDto.getCustomerAddress());</span>
<span class="nc" id="L144">        invoice.setTaxAmount(invoiceDto.getTaxAmount());</span>
<span class="nc" id="L145">        invoice.setDiscountAmount(invoiceDto.getDiscountAmount());</span>
<span class="nc" id="L146">        invoice.setNotes(invoiceDto.getNotes());</span>
<span class="nc" id="L147">        invoice.setStatus(invoiceDto.getStatus());</span>
        
        // Process new invoice items
<span class="nc bnc" id="L150" title="All 2 branches missed.">        for (InvoiceItemDto itemDto : invoiceDto.getItems()) {</span>
<span class="nc" id="L151">            Product product = productRepository.findById(itemDto.getProductId())</span>
<span class="nc" id="L152">                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Product&quot;, &quot;id&quot;, itemDto.getProductId()));</span>
            
<span class="nc bnc" id="L154" title="All 2 branches missed.">            if (!product.getUserId().equals(userId)) {</span>
<span class="nc" id="L155">                throw new BadRequestException(&quot;Product does not belong to the current user&quot;);</span>
            }
            
            // Allow invoice update even with zero stock - stock validation removed
            // Note: Product can have negative stock after this operation
            
<span class="nc" id="L161">            InvoiceItem item = new InvoiceItem();</span>
<span class="nc" id="L162">            item.setProduct(product);</span>
<span class="nc" id="L163">            item.setQuantity(itemDto.getQuantity());</span>
<span class="nc" id="L164">            item.setUnitPrice(itemDto.getUnitPrice());</span>
<span class="nc" id="L165">            item.setDescription(itemDto.getDescription());</span>
<span class="nc" id="L166">            item.setInvoice(invoice);</span>
            
<span class="nc" id="L168">            invoice.getItems().add(item);</span>
            
            // Update product quantity (convert BigDecimal to Integer for storage)
<span class="nc" id="L171">            int newQuantity = BigDecimal.valueOf(product.getQuantity()).subtract(itemDto.getQuantity()).intValue();</span>
<span class="nc" id="L172">            product.setQuantity(newQuantity);</span>
<span class="nc" id="L173">            productRepository.save(product);</span>
<span class="nc" id="L174">        }</span>
        
<span class="nc" id="L176">        invoice.calculateTotals();</span>
        
<span class="nc" id="L178">        Invoice updatedInvoice = invoiceRepository.save(invoice);</span>
        
<span class="nc" id="L180">        logger.info(&quot;Invoice updated: {} by user: {}&quot;, updatedInvoice.getInvoiceNumber(), userId);</span>
        
<span class="nc" id="L182">        return convertToDto(updatedInvoice);</span>
    }
    
    public void deleteInvoice(Long id) {
<span class="nc" id="L186">        Long userId = getCurrentUserId();</span>
        
<span class="nc" id="L188">        Invoice invoice = invoiceRepository.findById(id)</span>
<span class="nc" id="L189">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Invoice&quot;, &quot;id&quot;, id));</span>
        
<span class="nc bnc" id="L191" title="All 2 branches missed.">        if (!invoice.getUserId().equals(userId)) {</span>
<span class="nc" id="L192">            throw new BadRequestException(&quot;You don't have permission to delete this invoice&quot;);</span>
        }
        
<span class="nc bnc" id="L195" title="All 2 branches missed.">        if (invoice.getStatus() == Invoice.InvoiceStatus.PAID) {</span>
<span class="nc" id="L196">            throw new BadRequestException(&quot;Cannot delete a paid invoice&quot;);</span>
        }
        
        // Restore product quantities
<span class="nc bnc" id="L200" title="All 2 branches missed.">        for (InvoiceItem item : invoice.getItems()) {</span>
<span class="nc" id="L201">            Product product = item.getProduct();</span>
<span class="nc" id="L202">            int newQuantity = BigDecimal.valueOf(product.getQuantity()).add(item.getQuantity()).intValue();</span>
<span class="nc" id="L203">            product.setQuantity(newQuantity);</span>
<span class="nc" id="L204">            productRepository.save(product);</span>
<span class="nc" id="L205">        }</span>
        
<span class="nc" id="L207">        invoiceRepository.delete(invoice);</span>
        
<span class="nc" id="L209">        logger.info(&quot;Invoice deleted: {} by user: {}&quot;, invoice.getInvoiceNumber(), userId);</span>
<span class="nc" id="L210">    }</span>
    
    public InvoiceDto getInvoice(Long id) {
<span class="nc" id="L213">        Long userId = getCurrentUserId();</span>
        
<span class="nc" id="L215">        Invoice invoice = invoiceRepository.findById(id)</span>
<span class="nc" id="L216">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Invoice&quot;, &quot;id&quot;, id));</span>
        
<span class="nc bnc" id="L218" title="All 2 branches missed.">        if (!invoice.getUserId().equals(userId)) {</span>
<span class="nc" id="L219">            throw new BadRequestException(&quot;You don't have permission to access this invoice&quot;);</span>
        }
        
<span class="nc" id="L222">        return convertToDto(invoice);</span>
    }
    
    public Page&lt;InvoiceDto&gt; getAllInvoices(Pageable pageable) {
<span class="nc" id="L226">        Long userId = getCurrentUserId();</span>
        
<span class="nc" id="L228">        Page&lt;Invoice&gt; invoices = invoiceRepository.findByUserId(userId, pageable);</span>
        
<span class="nc" id="L230">        return invoices.map(this::convertToDto);</span>
    }
    
    public Page&lt;InvoiceDto&gt; searchInvoices(String keyword, Pageable pageable) {
<span class="nc" id="L234">        Long userId = getCurrentUserId();</span>
        
<span class="nc" id="L236">        Page&lt;Invoice&gt; invoices = invoiceRepository.searchInvoices(userId, keyword, pageable);</span>
        
<span class="nc" id="L238">        return invoices.map(this::convertToDto);</span>
    }
    
    public List&lt;InvoiceDto&gt; getInvoicesByStatus(Invoice.InvoiceStatus status) {
<span class="nc" id="L242">        Long userId = getCurrentUserId();</span>
        
<span class="nc" id="L244">        List&lt;Invoice&gt; invoices = invoiceRepository.findByUserIdAndStatus(userId, status);</span>
        
<span class="nc" id="L246">        return invoices.stream()</span>
<span class="nc" id="L247">            .map(this::convertToDto)</span>
<span class="nc" id="L248">            .collect(Collectors.toList());</span>
    }
    
    public List&lt;InvoiceDto&gt; getOverdueInvoices() {
<span class="nc" id="L252">        Long userId = getCurrentUserId();</span>
        
<span class="nc" id="L254">        List&lt;Invoice&gt; invoices = invoiceRepository.findOverdueInvoices(userId, LocalDate.now());</span>
        
<span class="nc" id="L256">        return invoices.stream()</span>
<span class="nc" id="L257">            .map(this::convertToDto)</span>
<span class="nc" id="L258">            .collect(Collectors.toList());</span>
    }
    
    public InvoiceDto updateInvoiceStatus(Long id, Invoice.InvoiceStatus status) {
<span class="nc" id="L262">        Long userId = getCurrentUserId();</span>
        
<span class="nc" id="L264">        Invoice invoice = invoiceRepository.findById(id)</span>
<span class="nc" id="L265">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Invoice&quot;, &quot;id&quot;, id));</span>
        
<span class="nc bnc" id="L267" title="All 2 branches missed.">        if (!invoice.getUserId().equals(userId)) {</span>
<span class="nc" id="L268">            throw new BadRequestException(&quot;You don't have permission to update this invoice&quot;);</span>
        }
        
<span class="nc" id="L271">        invoice.setStatus(status);</span>
<span class="nc" id="L272">        Invoice updatedInvoice = invoiceRepository.save(invoice);</span>
        
<span class="nc" id="L274">        logger.info(&quot;Invoice status updated: {} to {} by user: {}&quot;, </span>
<span class="nc" id="L275">                   updatedInvoice.getInvoiceNumber(), status, userId);</span>
        
<span class="nc" id="L277">        return convertToDto(updatedInvoice);</span>
    }
    
    public byte[] generateInvoicePdf(Long invoiceId) {
<span class="nc" id="L281">        Long userId = getCurrentUserId();</span>
        
<span class="nc" id="L283">        Invoice invoice = invoiceRepository.findById(invoiceId)</span>
<span class="nc" id="L284">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Invoice&quot;, &quot;id&quot;, invoiceId));</span>
        
<span class="nc bnc" id="L286" title="All 2 branches missed.">        if (!invoice.getUserId().equals(userId)) {</span>
<span class="nc" id="L287">            throw new BadRequestException(&quot;You don't have permission to generate PDF for this invoice&quot;);</span>
        }
        
        try {
<span class="nc" id="L291">            return pdfService.generateInvoicePdf(invoice);</span>
<span class="nc" id="L292">        } catch (Exception e) {</span>
<span class="nc" id="L293">            logger.error(&quot;Error generating PDF for invoice {}: {}&quot;, invoiceId, e.getMessage());</span>
<span class="nc" id="L294">            throw new RuntimeException(&quot;Failed to generate PDF: &quot; + e.getMessage(), e);</span>
        }
    }
    
    private String generateInvoiceNumber(Long userId) {
<span class="nc" id="L299">        String year = String.valueOf(Year.now().getValue());</span>
<span class="nc" id="L300">        Long count = invoiceRepository.countByUserId(userId);</span>
<span class="nc" id="L301">        return String.format(&quot;INV-%s-%s-%06d&quot;, userId, year, count + 1);</span>
    }
    
    private InvoiceDto convertToDto(Invoice invoice) {
<span class="nc" id="L305">        InvoiceDto dto = modelMapper.map(invoice, InvoiceDto.class);</span>
        
<span class="nc" id="L307">        List&lt;InvoiceItemDto&gt; itemDtos = invoice.getItems().stream()</span>
<span class="nc" id="L308">            .map(item -&gt; {</span>
<span class="nc" id="L309">                InvoiceItemDto itemDto = modelMapper.map(item, InvoiceItemDto.class);</span>
<span class="nc" id="L310">                itemDto.setProductId(item.getProduct().getId());</span>
<span class="nc" id="L311">                itemDto.setProductName(item.getProduct().getName());</span>
<span class="nc" id="L312">                itemDto.setProductCode(item.getProduct().getCode());</span>
<span class="nc" id="L313">                itemDto.setProductUnit(item.getProduct().getUnit().name());</span>
<span class="nc" id="L314">                return itemDto;</span>
            })
<span class="nc" id="L316">            .collect(Collectors.toList());</span>
        
<span class="nc" id="L318">        dto.setItems(itemDtos);</span>
        
<span class="nc" id="L320">        return dto;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>