<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProductService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">billing-backend</a> &gt; <a href="index.source.html" class="el_package">com.billing.service</a> &gt; <span class="el_source">ProductService.java</span></div><h1>ProductService.java</h1><pre class="source lang-java linenums">package com.billing.service;

import com.billing.dto.ProductDto;
import com.billing.entity.Product;
import com.billing.entity.UnitType;
import com.billing.entity.User;
import com.billing.exception.BadRequestException;
import com.billing.exception.ResourceNotFoundException;
import com.billing.repository.ProductRepository;
import com.billing.repository.UserRepository;
import com.billing.security.UserPrincipal;
import org.apache.commons.csv.CSVFormat;
import org.apache.commons.csv.CSVParser;
import org.apache.commons.csv.CSVRecord;
import org.modelmapper.ModelMapper;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.math.BigDecimal;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

@Service
@Transactional
<span class="nc" id="L38">public class ProductService {</span>
    
<span class="nc" id="L40">    private static final Logger logger = LoggerFactory.getLogger(ProductService.class);</span>
    
    @Autowired
    private ProductRepository productRepository;
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private ModelMapper modelMapper;
    
    private Long getCurrentUserId() {
<span class="nc" id="L52">        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="nc bnc" id="L53" title="All 4 branches missed.">        if (authentication != null &amp;&amp; authentication.getPrincipal() instanceof UserPrincipal) {</span>
<span class="nc" id="L54">            return ((UserPrincipal) authentication.getPrincipal()).getId();</span>
        }
<span class="nc" id="L56">        throw new RuntimeException(&quot;User not authenticated&quot;);</span>
    }
    
    private String generateUniqueProductCode(Long userId) {
<span class="nc" id="L60">        String prefix = &quot;PRD&quot;;</span>
        String code;
<span class="nc" id="L62">        int counter = 1;</span>
        
        do {
<span class="nc" id="L65">            code = prefix + String.format(&quot;%06d&quot;, counter);</span>
<span class="nc" id="L66">            counter++;</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">        } while (productRepository.findByCodeAndUserId(code, userId).isPresent());</span>
        
<span class="nc" id="L69">        return code;</span>
    }
    
    public ProductDto createProduct(ProductDto productDto) {
<span class="nc" id="L73">        Long userId = getCurrentUserId();</span>
        
<span class="nc" id="L75">        Product product = modelMapper.map(productDto, Product.class);</span>
        
        // Auto-generate unique product code
<span class="nc" id="L78">        String generatedCode = generateUniqueProductCode(userId);</span>
<span class="nc" id="L79">        product.setCode(generatedCode);</span>
<span class="nc" id="L80">        product.setUserId(userId);</span>
        
        // Convert string unit to enum
<span class="nc bnc" id="L83" title="All 2 branches missed.">        if (productDto.getUnit() != null) {</span>
<span class="nc" id="L84">            product.setUnit(UnitType.fromString(productDto.getUnit()));</span>
        }
        
<span class="nc" id="L87">        Product savedProduct = productRepository.save(product);</span>
        
<span class="nc" id="L89">        logger.info(&quot;Product created: {} by user: {}&quot;, savedProduct.getCode(), userId);</span>
        
<span class="nc" id="L91">        return convertToDto(savedProduct);</span>
    }
    
    public ProductDto updateProduct(Long id, ProductDto productDto) {
<span class="nc" id="L95">        Long userId = getCurrentUserId();</span>
        
<span class="nc" id="L97">        Product product = productRepository.findById(id)</span>
<span class="nc" id="L98">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Product&quot;, &quot;id&quot;, id));</span>
        
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (!product.getUserId().equals(userId)) {</span>
<span class="nc" id="L101">            throw new BadRequestException(&quot;You don't have permission to update this product&quot;);</span>
        }
        
        // Map only the updatable fields, preserving the existing code
<span class="nc" id="L105">        String existingCode = product.getCode();</span>
<span class="nc" id="L106">        modelMapper.map(productDto, product);</span>
<span class="nc" id="L107">        product.setCode(existingCode); // Keep the original auto-generated code</span>
<span class="nc" id="L108">        product.setUserId(userId); // Ensure userId doesn't get overwritten</span>
        
        // Convert string unit to enum
<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (productDto.getUnit() != null) {</span>
<span class="nc" id="L112">            product.setUnit(UnitType.fromString(productDto.getUnit()));</span>
        }
        
<span class="nc" id="L115">        Product updatedProduct = productRepository.save(product);</span>
        
<span class="nc" id="L117">        logger.info(&quot;Product updated: {} by user: {}&quot;, updatedProduct.getCode(), userId);</span>
        
<span class="nc" id="L119">        return convertToDto(updatedProduct);</span>
    }
    
    public void deleteProduct(Long id) {
<span class="nc" id="L123">        Long userId = getCurrentUserId();</span>
        
<span class="nc" id="L125">        Product product = productRepository.findById(id)</span>
<span class="nc" id="L126">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Product&quot;, &quot;id&quot;, id));</span>
        
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (!product.getUserId().equals(userId)) {</span>
<span class="nc" id="L129">            throw new BadRequestException(&quot;You don't have permission to delete this product&quot;);</span>
        }
        
<span class="nc" id="L132">        productRepository.delete(product);</span>
        
<span class="nc" id="L134">        logger.info(&quot;Product deleted: {} by user: {}&quot;, product.getCode(), userId);</span>
<span class="nc" id="L135">    }</span>
    
    public ProductDto getProduct(Long id) {
<span class="nc" id="L138">        Long userId = getCurrentUserId();</span>
        
<span class="nc" id="L140">        Product product = productRepository.findById(id)</span>
<span class="nc" id="L141">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Product&quot;, &quot;id&quot;, id));</span>
        
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (!product.getUserId().equals(userId)) {</span>
<span class="nc" id="L144">            throw new BadRequestException(&quot;You don't have permission to access this product&quot;);</span>
        }
        
<span class="nc" id="L147">        return convertToDto(product);</span>
    }
    
    public Page&lt;ProductDto&gt; getAllProducts(Pageable pageable) {
<span class="nc" id="L151">        Long userId = getCurrentUserId();</span>
        
<span class="nc" id="L153">        Page&lt;Product&gt; products = productRepository.findByUserIdAndActive(userId, true, pageable);</span>
        
<span class="nc" id="L155">        return products.map(this::convertToDto);</span>
    }
    
    public Page&lt;ProductDto&gt; searchProducts(String keyword, Pageable pageable) {
<span class="nc" id="L159">        Long userId = getCurrentUserId();</span>
        
<span class="nc" id="L161">        Page&lt;Product&gt; products = productRepository.searchProducts(userId, keyword, pageable);</span>
        
<span class="nc" id="L163">        return products.map(this::convertToDto);</span>
    }
    
    public List&lt;ProductDto&gt; getProductsByCategory(String category) {
<span class="nc" id="L167">        Long userId = getCurrentUserId();</span>
        
<span class="nc" id="L169">        List&lt;Product&gt; products = productRepository.findByUserIdAndCategory(userId, category);</span>
        
<span class="nc" id="L171">        return products.stream()</span>
<span class="nc" id="L172">            .map(this::convertToDto)</span>
<span class="nc" id="L173">            .collect(Collectors.toList());</span>
    }
    
    public List&lt;String&gt; getCategories() {
<span class="nc" id="L177">        Long userId = getCurrentUserId();</span>
        
<span class="nc" id="L179">        return productRepository.findCategoriesByUserId(userId);</span>
    }
    
    public List&lt;ProductDto&gt; getLowStockProducts() {
<span class="nc" id="L183">        Long userId = getCurrentUserId();</span>
        
<span class="nc" id="L185">        List&lt;Product&gt; products = productRepository.findLowStockProducts(userId);</span>
        
<span class="nc" id="L187">        return products.stream()</span>
<span class="nc" id="L188">            .map(this::convertToDto)</span>
<span class="nc" id="L189">            .collect(Collectors.toList());</span>
    }
    
    public List&lt;ProductDto&gt; bulkUploadProducts(MultipartFile file) throws IOException {
<span class="nc" id="L193">        Long userId = getCurrentUserId();</span>
        
<span class="nc bnc" id="L195" title="All 2 branches missed.">        if (file.isEmpty()) {</span>
<span class="nc" id="L196">            throw new BadRequestException(&quot;File is empty&quot;);</span>
        }
        
<span class="nc" id="L199">        List&lt;ProductDto&gt; uploadedProducts = new ArrayList&lt;&gt;();</span>
        
<span class="nc" id="L201">        try (BufferedReader reader = new BufferedReader(</span>
<span class="nc" id="L202">                new InputStreamReader(file.getInputStream(), StandardCharsets.UTF_8))) {</span>
            
<span class="nc" id="L204">            CSVParser csvParser = CSVFormat.DEFAULT</span>
<span class="nc" id="L205">                .withFirstRecordAsHeader()</span>
<span class="nc" id="L206">                .withIgnoreHeaderCase()</span>
<span class="nc" id="L207">                .withTrim()</span>
<span class="nc" id="L208">                .parse(reader);</span>
            
<span class="nc bnc" id="L210" title="All 2 branches missed.">            for (CSVRecord csvRecord : csvParser) {</span>
                try {
<span class="nc" id="L212">                    ProductDto productDto = new ProductDto();</span>
                    // Don't set code from CSV - it will be auto-generated
<span class="nc" id="L214">                    productDto.setName(csvRecord.get(&quot;name&quot;));</span>
<span class="nc" id="L215">                    productDto.setDescription(csvRecord.get(&quot;description&quot;));</span>
<span class="nc" id="L216">                    productDto.setPrice(new BigDecimal(csvRecord.get(&quot;price&quot;)));</span>
<span class="nc" id="L217">                    productDto.setMrp(new BigDecimal(csvRecord.get(&quot;mrp&quot;)));</span>
<span class="nc" id="L218">                    productDto.setQuantity(Integer.parseInt(csvRecord.get(&quot;quantity&quot;)));</span>
<span class="nc" id="L219">                    productDto.setMinStockLevel(Integer.parseInt(csvRecord.get(&quot;minStockLevel&quot;)));</span>
<span class="nc" id="L220">                    productDto.setCategory(csvRecord.get(&quot;category&quot;));</span>
<span class="nc" id="L221">                    productDto.setUnit(csvRecord.get(&quot;unit&quot;));</span>
<span class="nc" id="L222">                    productDto.setActive(true); // Explicitly set active to true</span>
                    
<span class="nc" id="L224">                    Product product = modelMapper.map(productDto, Product.class);</span>
                    
                    // Auto-generate unique product code
<span class="nc" id="L227">                    String generatedCode = generateUniqueProductCode(userId);</span>
<span class="nc" id="L228">                    product.setCode(generatedCode);</span>
<span class="nc" id="L229">                    product.setUserId(userId);</span>
<span class="nc" id="L230">                    product.setActive(true); // Explicitly set active to true on entity as well</span>
                    
                    // Convert string unit to enum
<span class="nc bnc" id="L233" title="All 2 branches missed.">                    if (productDto.getUnit() != null) {</span>
<span class="nc" id="L234">                        product.setUnit(UnitType.fromString(productDto.getUnit()));</span>
                    }
                    
<span class="nc" id="L237">                    Product savedProduct = productRepository.save(product);</span>
<span class="nc" id="L238">                    uploadedProducts.add(convertToDto(savedProduct));</span>
                    
<span class="nc" id="L240">                    logger.debug(&quot;Successfully processed product: {} with code: {}&quot;, product.getName(), product.getCode());</span>
                    
<span class="nc" id="L242">                } catch (Exception e) {</span>
<span class="nc" id="L243">                    logger.error(&quot;Error processing CSV record: {}&quot;, csvRecord, e);</span>
<span class="nc" id="L244">                }</span>
<span class="nc" id="L245">            }</span>
        }
        
<span class="nc" id="L248">        logger.info(&quot;Bulk upload completed. {} products uploaded by user: {}&quot;, uploadedProducts.size(), userId);</span>
        
<span class="nc" id="L250">        return uploadedProducts;</span>
    }
    
    private ProductDto convertToDto(Product product) {
<span class="nc" id="L254">        ProductDto dto = modelMapper.map(product, ProductDto.class);</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (product.getUnit() != null) {</span>
<span class="nc" id="L256">            dto.setUnit(product.getUnit().name());</span>
        }
<span class="nc" id="L258">        return dto;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>